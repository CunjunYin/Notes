# Authentication code
In OAuth, the `authentication code` is a short-lived, one-time token that is used to obtain an access token, which can be used to access a user's protected resources.

# Requesting paramaters in `authentication code` request
| Parameter     |      Description             |
|---------------|:-----------------------------|
| Audience      | The identifier is the intent of the resource the client is requesting access to. The authorization server include this identifier in the access token to ensure it only accepted by intended resource server - validate before further process.|
| Client ID     | The identifier is a value assigned to a client application when registering with the authorization server. It is used to identify the client application when it requests access to protected resources on behalf of an end user. |
| Redirect URI  | The redirect URI should be registered in client registration stage, it is used to redirects the user's browser to this URI, along with additional parameters that provide information about the authorization status and any access tokens that have been issued.|
| Response Type | In authentication code this is set as `code`. By specify the type, the authorization server knows what information to responsed. |
| Scope         | A set of permissions that the client application is required to process user's request. The user must grant these permissions in order for the client to access their resources |
| Nonce         | It is used to prevent prevent [replay attacks](https://en.wikipedia.org/wiki/Replay_attack). This value is random generated by client application and authorization server respond same nonce back.|

```
POST /api/oauth HTTP/1.1
Host: oauth.com

audience="/api/resource/user"
&client_id=xxxxxxxxxx
&redirect_uri=https://client.com/redirect
&respons_type=authorization_code
&scope=openid.name.r openid.email.r
&nounce = xxxxxxxxxx
```

# Validation process before issue Authorization Code for authorization server
When OAuth server received request from Third Party. Some common validations are required before respond credential page to the user.

1. Response Type validation: Check the request is for Authorization Code 
```cs
if(!string.Equals("code", model.responseType))
{
    // Invalid Request
}
```

2. Client registration: The Client must be registered with the authorization server,the request must include client ID and secret key. This step helps ensure the client is legitimate.
```cs
var client = clients.getClientOrNull(model.client_id)
if (client == null)
{
    // Unknow Client, reject   
}
```

3. Redirect URI validation: the request need to contain one redirect URI where the authorization code will be sent. To prevent unauthorized access, OAuth Server need to check it's registered.
```cs
if (!client.redirectUris.Contain(model.redirectUri))
{
    // Wrong redirectUri, reject 
}
```

Scope verification: client request scopes to access resources, but those scopes must be pre-registered and in avaiable scope domain.
```cs
for (scope in model.scopes)
{
    if(!client.scopes.Contain(scope))
    {
        // Out of registered scopes, reject 
    }
}
```

4. User authentication: Authorization server initiates an authentication and authorization request and gather user credential and approved scopes, again to ensure user authorized scopes are align with client `requsted scopes`.

```c#
if (!checkScope(model.scopes, loginModel.scopes))
{
    // Requested scopes are out of user approved scopes
}
```

5. Redirect to third-party software: After successfull authentication, the OAuth server respond a redirect request with Authorization Code

```c#
string code = generateAuthorizationCode(client);

return Redirect(string.format("{0}?code={1}", model.redirect_uri, code))
```

# Security Considerations
Authorization code can be only used once, if failed to comply with this rule, the authorization server must deny the subsequent requests and if prossible the service should revoke the previous access tokens were issued by this authorization code. For `self-encoded authorization codes` (not in database), the server should implement a cache mechanism to prevent replay attack.
